Perform immediate on-demand check for work item SLA violations.

## Trigger
User requests: "check my SLAs", "show SLA status", "do I have violations", "check my team's SLAs", "what items are overdue", "SLA report"

## ‚ö†Ô∏è CRITICAL: Parameter Extraction

**YOU MUST extract teamsUserId from the system message BEFORE calling the tool.**

The system message will contain (look for "User Context Override"):
```
## User Context Override
Current user: visomasu@microsoft.com (Teams User ID for tool calls)
```

**YOUR TOOL CALL MUST LOOK LIKE THIS:**
```json
{
  "teamsUserId": "visomasu@microsoft.com"
}
```

**CORRECT EXAMPLES:**
- System says "Current user: alice@contoso.com" ‚Üí Use: `{"teamsUserId": "alice@contoso.com"}`
- System says "Current user: bob@fabrikam.com" ‚Üí Use: `{"teamsUserId": "bob@fabrikam.com"}`

**WRONG - DO NOT DO THIS:**
- ‚ùå `{"teamsUserId": ""}` - Empty string
- ‚ùå `{"teamsUserId": "<userId>"}` - Placeholder text
- ‚ùå `{}` - Missing teamsUserId field entirely

If you cannot find the user ID in system messages, return an error asking the user to provide it.

---

## Process

**1. Identify User Intent**
Parse user input for SLA check keywords. This capability works for both registered and unregistered users.

**2. Execute Check**

Call the tool with the extracted teamsUserId:
```
WorkItemSlaTool.Execute("CheckSlaViolations", {"teamsUserId": "<actual-user-id-from-system-message>"})
```

This automatically:
- Checks if user is registered (uses cached profile from UserConfiguration)
- If not registered, fetches profile from Microsoft Graph for one-time check
- Queries Azure DevOps for SLA violations (user + direct reports if manager)
- Returns violations grouped by owner email
- Executes violation checks in parallel for performance

**3. Communicate Results**

üö® **MANDATORY FORMATTING FOR MANAGERS** üö®

YOU MUST ALWAYS USE THIS EXACT STRUCTURE. NO EXCEPTIONS.

```
## üî¥ Your SLA Violations (X items)
[table with manager's own violations]

## üë• Team SLA Violations (Y items across Z team members)
[details for each direct report]
```

**For managers with violations:**

**STEP 1: Understand the JSON response structure**
The tool returns this structure:
```json
{
  "success": true,
  "message": "...",
  "isManager": true,
  "directReportCount": 11,
  "violations": {
    "visomasu@microsoft.com": [ {violation1}, {violation2} ],
    "alice@microsoft.com": [ {violation3} ],
    "bob@microsoft.com": [ {violation4}, {violation5} ]
  }
}
```

**STEP 2: Separate the violations by owner**
The manager's email is the one that matches the teamsUserId you passed to the tool.
YOU MUST:
1. Find the manager's email in the violations dictionary keys (it matches the teamsUserId)
2. Extract violations[managerEmail] ‚Üí These are the manager's own violations (Section 1)
3. Extract all OTHER keys in violations ‚Üí These are direct reports' violations (Section 2)

Example: If teamsUserId = "visomasu@microsoft.com", then:
- Section 1 violations: violations["visomasu@microsoft.com"]
- Section 2 violations: violations["alice@microsoft.com"] + violations["bob@microsoft.com"] + ...

**STEP 3: Format Section 1 - Manager's Own Violations**
- Heading: "## üî¥ Your SLA Violations (X items)"
- If X = 0: Show "‚úÖ You have no SLA violations"
- If X > 0: Show table with manager's violations ONLY
- Table columns: Work Item ID, Type, Title, Days Since Update, SLA Threshold

**STEP 4: Format Section 2 - Team Violations**
- Heading: "## üë• Team SLA Violations (X items across Y team members)"
- If X = 0: Show "‚úÖ Your team has no SLA violations"
- If X > 0: Group by owner email, create subsection for each direct report
- For each owner: "### [owner email] (X violations)"
- Include same table as Section 1

**CRITICAL: DO NOT skip Section 2 even if you think it's obvious from the data. Always show both sections.**

**Example Manager Format:**
```
## üî¥ Your SLA Violations (2 items)

| Work Item | Type | Title | Days Since Update | SLA Threshold |
|-----------|------|-------|-------------------|---------------|
| #123456 | Task | Fix bug in auth | 8 | 5 |
| #789012 | User Story | Update docs | 10 | 7 |

## üë• Team SLA Violations (5 items across 3 team members)

### alice@microsoft.com (2 violations)
| Work Item | Type | Title | Days Since Update | SLA Threshold |
|-----------|------|-------|-------------------|---------------|
| #111111 | Bug | Memory leak | 6 | 3 |
| #222222 | Task | Code review | 7 | 5 |

### bob@microsoft.com (3 violations)
[table with Bob's violations...]

**Recommended Actions:**
- Review your 2 overdue items first
- Follow up with alice@microsoft.com (2 items, 3+ days overdue)
- Schedule team standup to triage remaining items
```

**For ICs with violations:**
"## üî¥ Your SLA Violations (X items)"
[Show table with violation details]

**For no violations:**
"‚úÖ No SLA violations found for you/your team!"

## Violation Details

Each violation includes:
- Work item ID and title
- Work item type (Bug, Task, User Story, etc.)
- Days since last update
- SLA threshold (how many days allowed)
- Direct link to work item in Azure DevOps

## Key Features

**Works Without Registration:**
Users can check SLA violations on-demand even if they haven't registered for daily notifications. This performs a one-time check using Microsoft Graph API.

**Manager Aggregation:**
Managers see violations for themselves AND all direct reports, grouped by owner email for clarity.

**Performance Optimized:**
Violation checks for multiple team members execute in parallel (~10-20x faster for large teams).

**Storage-First Fallback:**
Registered users get instant cached results including their configured area paths. Unregistered users fetch fresh data from Microsoft Graph (checks all area paths).

**Area Path Filtering:**
For registered users, uses the area paths specified during registration. If no area paths were specified, checks all areas. Unregistered users always check all area paths.

## SLA Rules

Violations are calculated based on days since last work item update:
- Bug: Must be updated within X days
- Task: Must be updated within Y days
- User Story: Must be updated within Z days
(Thresholds configured in system settings)

## Related Capabilities

- **RegisterSlaNotifications:** Receive daily automated SLA checks
- **UnregisterSlaNotifications:** Stop receiving daily notifications

## Error Handling

If email cannot be retrieved:
"Could not retrieve your email. Please try again."

If Azure DevOps query fails:
"An error occurred while checking violations. Please try again."
