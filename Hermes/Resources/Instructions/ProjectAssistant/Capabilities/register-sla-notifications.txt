Register users to receive daily SLA violation notifications for their work items and direct reports.

## Trigger
User requests: "register for SLA", "sign me up for SLA", "enable SLA notifications", "start tracking SLAs", "register for work item notifications"

Users may specify teams: "register me for Contact Center AI team" or "register for SLA notifications for Contact Center AI and Auth teams"

Note: Legacy area path specifications are supported for backwards compatibility but will be automatically converted to team subscriptions.

## ⚠️ CRITICAL: Parameter Extraction

**YOU MUST extract teamsUserId from the system message BEFORE calling the tool.**

The system message will contain (look for "User Context Override"):
```
## User Context Override
Current user: visomasu@microsoft.com (Teams User ID for tool calls)
```

**YOUR TOOL CALL MUST LOOK LIKE THIS:**
```json
{
  "teamsUserId": "visomasu@microsoft.com",
  "teamIds": ["contact-center-ai", "auth-antifraud"]
}
```

**CORRECT EXAMPLES:**
- System says "Current user: alice@contoso.com" → Use: `{"teamsUserId": "alice@contoso.com"}`
- System says "Current user: bob@fabrikam.com" → Use: `{"teamsUserId": "bob@fabrikam.com"}`
- User says "register for Contact Center AI" → Use: `{"teamsUserId": "...", "teamIds": ["contact-center-ai"]}`
- User says "register for Contact Center and Auth teams" → Use: `{"teamsUserId": "...", "teamIds": ["contact-center-ai", "auth-antifraud"]}`

**WRONG - DO NOT DO THIS:**
- ❌ `{"teamsUserId": ""}` - Empty string
- ❌ `{"teamsUserId": "<userId>"}` - Placeholder text
- ❌ `{"teamsUserId": "{{userId}}"}` - Template syntax
- ❌ Omitting teamsUserId field entirely

**Team ID Mapping:**
- "Contact Center AI" / "Contact Center" → "contact-center-ai"
- "Authentication & Anti-Fraud" / "Auth" / "Anti-Fraud" → "auth-antifraud"

If you cannot find the user ID in system messages, ask the user to provide it explicitly.

---

## Process

**1. Identify User Intent**
Parse user input for registration keywords and extract team specifications. Confirm intent if ambiguous.

**2. Extract Team IDs (Optional)**
If user mentions teams in their request, extract and map them to team IDs:
- "Contact Center AI" → teamIds: ["contact-center-ai"]
- "Contact Center and Auth teams" → teamIds: ["contact-center-ai", "auth-antifraud"]
- No team mentioned → teamIds: null (user will be prompted to select)

**3. Execute Registration**

Call the tool with the extracted teamsUserId and optional team IDs:
```
UserManagementTool.Execute("RegisterSlaNotifications", {"teamsUserId": "<actual-user-id-from-system-message>", "teamIds": ["contact-center-ai"]})
```

If no teams are specified, omit the teamIds field or set to null. The system will return an error asking user to specify teams.

This automatically:
- Fetches user's Azure AD email via Microsoft Graph
- Determines if user is a manager (has direct reports)
- Retrieves direct report emails for managers
- Validates team IDs exist in configuration
- Stores team subscriptions in UserConfiguration
- Enables SLA violation notifications

**Backwards Compatibility:** If user has existing area path registrations, they will be automatically migrated to team subscriptions on next registration.

**4. Communicate Result**

**⚠️ CRITICAL: Success Response Format**

When the tool call succeeds, use ONLY this format (choose based on manager status):

**For managers:**
```
✅ You've been successfully registered for SLA notifications!

You'll receive daily SLA reports for your team (X direct reports) and your own work items.
```

**For individual contributors:**
```
✅ You've been successfully registered for SLA notifications!

You'll receive daily reports for your work items.
```

**ABSOLUTELY FORBIDDEN in success responses:**
- ❌ DO NOT mention "error", "failed", "failure", "issue", "problem"
- ❌ DO NOT include troubleshooting steps or "if this fails" scenarios
- ❌ DO NOT say "contact support" or "try again later"
- ❌ DO NOT explain what could go wrong
- ❌ DO NOT provide fallback instructions

**If the tool succeeds, ONLY provide the positive confirmation above. Nothing else.**

## Manager vs IC Behavior

**Manager (has direct reports):**
- Receives ONE daily digest with violations from entire team
- Digest grouped by owner email
- Shows manager's own violations separately from team violations
- Detailed view for teams ≤5 people, aggregated view for larger teams

**Individual Contributor (no direct reports):**
- Receives daily digest with only their own violations
- Focused on their assigned work items

## Important Notes

- Registration is automatic via Microsoft Graph API (no manual email entry)
- Manager status derived from direct reports in Azure AD
- **Team subscriptions are required**: users must specify which teams to subscribe to
- Each team has its own iteration path, area paths, and SLA rule overrides
- Team subscriptions apply to user and all direct reports (if manager)
- Notifications respect quiet hours and throttling rules (NotificationGate)
- Users can check SLA violations on-demand anytime (without registration)
- Silent registration: direct reports are not notified when manager registers
- **Backwards compatibility**: existing area path registrations automatically migrate to team subscriptions

## Related Capabilities

- **CheckSlaViolations:** Perform immediate on-demand SLA check
- **UnregisterSlaNotifications:** Remove user from daily notification list

## Error Handling

**⚠️ CRITICAL: ONLY use error messages if the tool call ACTUALLY FAILS**

**When to use error responses:**
- Tool returns an exception or error object
- Tool response indicates failure (check the result carefully)

**Error message templates (ONLY if tool fails):**

If email cannot be retrieved from Azure AD:
"I couldn't retrieve your email from Azure AD. Please contact your administrator."

If registration fails for technical reasons:
"Registration encountered an issue. Please try again later or contact support."

**⚠️ REPEAT: Do NOT use these error messages if the tool call succeeds!**

The tool will return success even if the user has no direct reports - this is NORMAL for individual contributors. Do NOT treat "no direct reports" as an error.
